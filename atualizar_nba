import requests
import os
from supabase import create_client

# Configura√ß√µes de Ambiente (Puxadas do GitHub Actions)
SUPABASE_URL = os.environ.get("SUPABASE_URL")
SUPABASE_KEY = os.environ.get("SUPABASE_KEY")
API_SPORTS_KEY = os.environ.get("API_SPORTS_KEY")

# Inicializa o cliente Supabase
db = create_client(SUPABASE_URL, SUPABASE_KEY)

def rodar():
    # URL Direta da API-Sports
    url = "https://v1.nba.api-sports.io/standings"
    
    # Par√¢metros para a liga standard e temporada atual (2024-25)
    querystring = {"league": "standard", "season": "2024"}
    
    # Cabe√ßalho de autentica√ß√£o espec√≠fico da API-Sports
    headers = {
        "x-apisports-key": API_SPORTS_KEY
    }

    try:
        print("üèÄ Iniciando busca de dados na API-Sports...")
        response = requests.get(url, headers=headers, params=querystring)
        response.raise_for_status() # Garante que o script para se houver erro de conex√£o
        
        dados_json = response.json()
        standings = dados_json.get('response', [])

        if not standings:
            print("‚ö†Ô∏è A API n√£o retornou dados de classifica√ß√£o.")
            return

        lista_times = []

        for item in standings:
            # No JSON da API, os dados est√£o hierarquizados. 
            # O nome do time e as vit√≥rias est√£o no mesmo objeto 'item'.
            dados_formatados = {
                "time": item['team']['name'],
                "v": str(item['win']['total']),
                "d": str(item['loss']['total']),
                "pct": str(item['win']['percentage']),
                "ja": str(item['gamesBehind'] if item['gamesBehind'] else '-'),
                "casa": f"{item['win']['home']}-{item['loss']['home']}",
                "visitante": f"{item['win']['away']}-{item['loss']['away']}",
                "div": f"{item['division']['name']} ({item['division']['rank']})",
                "conf": f"{item['conference']['name']} ({item['conference']['rank']})",
                "pts": "0", # A API de Standings foca em Vit√≥rias/Derrotas
                "pts_contra": "0",
                "dif": "0",
                "strk": str(item['streak']) if item['streak'] else '0'
            }
            lista_times.append(dados_formatados)

        # Atualiza√ß√£o no Supabase
        if lista_times:
            # 1. Limpa a tabela atual
            db.table("classificacao_nba").delete().neq("time", "vazio").execute()
            
            # 2. Insere os novos dados (30 times perfeitamente alinhados)
            db.table("classificacao_nba").insert(lista_times).execute()
            
            print(f"‚úÖ Sucesso! {len(lista_times)} times atualizados sem erros.")

    except Exception as e:
        print(f"‚ùå Erro cr√≠tico: {e}")

if __name__ == "__main__":
    rodar()
